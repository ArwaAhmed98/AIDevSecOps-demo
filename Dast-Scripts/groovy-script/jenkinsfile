pipeline {
    agent {
        kubernetes {
            defaultContainer 'build'
            yaml """
            apiVersion: v1
            kind: Pod
            metadata:
            labels:
                jenkins: slave
            spec:
                containers:
                  - name: build
                    image: fadifarid/redhat-python
                    command: [ "sh", "-c", "sleep infinity" ]
                    tty: true
                    securityContext:
                        runAsUser: 0
                        runAsGroup: 0
                    volumeMounts:
                    - name: workspace-volume
                      mountPath: /home/jenkins/agent
            volumes:
              - name: workspace-volume
                emptyDir: {}
            """
        }
    }

    parameters {
        string(name: 'REPONAME', defaultValue: 'https://github.com/MostafaAnas/go-cli-todo',
            description: 'Repository name (e.g., org/repo or repo)')
    }

    stages {
        stage('Checkout current repo (target)') {
            steps {
                checkout scm
            }
        }

        stage('Zap-scan') {
            steps {
                container('build') {
                    sh """
                    cd /opt/zaproxy
                    ls -la
                    
                    ./zap.sh -daemon -port 8080 -config api.key=vh7bqrauhothh2b0en7r53se5i &
                    sleep 60
                    python3 ${env.WORKSPACE}/Dast-Scripts/Zap-scan.py --repo "$REPONAME" || true
                    python3 ${env.WORKSPACE}/Dast-Scripts/Zap-scan.py --repo "$REPONAME"
                    pkill -f zap.sh
                    """
                }
            }
        }

        stage('PR creation') {
            steps {
                container('build') {
                    sh 'python3 Scripts/Createpr.py'
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline completed.'
        }
    }
}
