pipeline {
    agent {
    kubernetes {
      label "go-agent-${env.BUILD_NUMBER}"
      defaultContainer 'go'
      yaml """
        apiVersion: v1
        kind: Pod
        metadata:
            name: dynamic-agent
            labels:
                type: go-build
        spec:
            restartPolicy: Never
            containers:
              - name: go
                image: golang:1.23-bookworm
                tty: true
                command:
                    - cat
                resources:
                    requests:
                        cpu: "200m"
                        memory: "512Mi"
                    limits:
                        cpu: "1"
                        memory: "1Gi"
                volumeMounts:
                    - name: workspace-vol
                      mountPath: /home/jenkins/agent
            volumes:
              - name: workspace-vol
                emptyDir: {}
        """
            }
        }

    
    parameters {
        string(name: 'REPO_URL', defaultValue: 'https://github.com/user/repo', description: 'GitHub repository URL to scan')
        string(name: 'OLLAMA_MODEL', defaultValue: 'llama3.2:1b', description: 'Ollama model to use')
        string(name: 'OLLAMA_SERVER_URL', defaultValue: 'http://localhost:11434', description: 'Ollama server URL')
        string(name: 'OUTPUT_FILE', defaultValue: '', description: 'Output file name (optional)')
    }
    
    stages {
        stage('Install Go and Run Scan') {
            steps {
                dir('code-scan-llm/scan-repo') {
                    sh """
                  
                        # Initialize Go module if needed
                        if [ ! -f go.mod ]; then
                            go mod init code-scan-llm
                        fi
                        
                        # Install dependencies
                        go mod tidy
                        
                        # Run the scan
                        export OLLAMA_MODEL="${params.OLLAMA_MODEL}"
                        export OLLAMA_SERVER_URL="${params.OLLAMA_SERVER_URL}"
                        if [ -n "${params.OUTPUT_FILE}" ]; then
                            export OUTPUT_FILE="${params.OUTPUT_FILE}"
                        fi
                        go run main.go "${params.REPO_URL}"
                    """
                }
            }
        }
        
        stage('Archive Results') {
            steps {
                dir('code-scan-llm/scan-repo') {
                    archiveArtifacts artifacts: 'scan-results-*.txt', allowEmptyArchive: true
                }
            }
        }
    }
}
